Bootstrap: docker
From: ubuntu:16.04
IncludeCmd: yes

%labels
Maintainer alexander.stuckey@scilifelab.se
Version 1.0

%environment
	SHELL=/bin/bash
	export SHELL

%post
	#----------------------
	#Install required tools
	#---------------------
	
	apt-get -y update
	apt-get upgrade -y
	apt-get -y install wget sudo
	apt-get -y install build-essential
	apt-get -y install cmake git libgtk2.0-dev pkg-config libavcodec-dev libavformat-dev libswscale-dev libboost-all-dev ctags
	apt-get -y install python-dev python-numpy libtbb2 libtbb-dev libjpeg-dev libpng-dev libtiff-dev libjasper-dev libdc1394-22-dev python-pip
	apt-get -y install npm
	pip install --upgrade pip
	apt-get -y install uwsgi uwsgi-core uwsgi-plugin-python
	rm /bin/sh
	ln -s /bin/bash /bin/sh

	#----------------
	#Make home folder
	#----------------

	mkdir -p /home/st_aligner

	#--------------
	#Install opencv
	#--------------

	echo "Downloading and installing opencv 3.2.0"
	mkdir -p /github_dl
	cd /github_dl
	wget https://github.com/opencv/opencv/archive/3.2.0.tar.gz
	tar -zxvf 3.2.0.tar.gz
	cd opencv-3.2.0
	mkdir -p build
	cd build
	cmake -D CMAKE_BUILD_TYPE=Release -D CMAKE_INSTALL_PREFIX=/usr/local ..
	make -j2
	sudo make install	

	#----------------------------------
	#Install tissue recognition library
	#----------------------------------

	echo "Installing tissue recognition library"
	cd /github_dl
	git clone https://github.com/SpatialTranscriptomicsResearch/tissue_recognition
	cd tissue_recognition
	mkdir -p build
	cd build
	cmake ..
	make install
	pip install setuptools
	cd ../python-module
	python setup.py install
	
	#------------------
	#Install st aligner
	#------------------

	echo "Installing st_aligner"
	cd /github_dl
	git clone https://github.com/SpatialTranscriptomicsResearch/st_aligner.git
	cd st_aligner
	pip install -r server/requirements.txt
	pip install virtualenv
	virtualenv /home/st_aligner/venv
	pip install -r server/requirements.txt
	bash /home/st_aligner/venv/bin/activate
	sed -i '/chdir/c\chdir = /home/st_aligner/server' /github_dl/st_aligner/server/uwsgi-server-config.ini
	sed -i '/logto/c\logto = /home/st_aligner/server/logs/%n.log' /github_dl/st_aligner/server/uwsgi-server-config.ini
	sed -i '/plugin/c\plugin = /usr/lib/uwsgi/plugins/python_plugin.so' /github_dl/st_aligner/server/uwsgi-server-config.ini
	sed -i '/venv/c\venv = /home/st_aligner/venv' /github_dl/st_aligner/server/uwsgi-server-config.ini
	sed -i '/static-map/c\static-map = /=/home/st_aligner/client' /github_dl/st_aligner/server/uwsgi-server-config.ini
	sudo cp server/uwsgi-server-config.ini /etc/uwsgi/apps-available/
	sudo ln -s /etc/uwsgi/apps-available/uwsgi-server-config.ini /etc/uwsgi/apps-enabled/uwsgi-server-config.ini
	cd /github_dl/st_aligner/client
	npm install
	ln -s /usr/bin/nodejs /usr/bin/node
	git checkout develop
	git pull origin develop
	make DEVEL=1

	#--------------------------------
	#Set up folders to run st_aligner
	#--------------------------------

	cp -R /github_dl/st_aligner/server /home/st_aligner/server
	cp -R /github_dl/st_aligner/client /home/st_aligner/client
	mv /home/st_aligner/server/utils.py /home/st_aligner/server/utility.py
	cp -R /github_dl/tissue_recognition/python-module/tissue_recognition/*.py /home/st_aligner/server
	cp /github_dl/tissue_recognition/build/src/*.so /home/st_aligner/server
	cp /github_dl/opencv-3.2.0/build/lib/libopencv_core.so.3.2 /home/st_aligner/server
	cp /github_dl/opencv-3.2.0/build/lib/libopencv_imgproc.so.3.2 /home/st_aligner/server
	mkdir -p /home/st_aligner/server/logs
	ln -s /home/st_aligner/client /home/st_aligner/server/client
	chmod -R 0777 /home/st_aligner/
	
	#----------------------------
	#Edit scripts to work locally
	#----------------------------
	
	cd /home/st_aligner/server
	sed -i 's/utils/utility/g' < server.py
	sed -i 's@../client/devel@client/devel@g' < server.py
	sed -i 's/from . import utils/import utils/ < tissue_recognition.py
	sed '9,11d' tissue_recognition.py
	sed -i 's/LIB_FILE/\"/home/st_aligner/server/libtissue-recognition.so\"/' < tissue_recognition.py

	#--------
	#Clean up
	#--------

	rm /github_dl/*.tar.gz
	exit 0
	
%runscript

	echo "Starting uwsgi webserver..."
	cd /home/st_aligner/
	#virtualenv venv
	python server/server.py
